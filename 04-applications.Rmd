# Applications of `nlmixr` {#applications}


<!-- ## Posters and Presentations -->
## Posters and Presentations

```{r echo=FALSE, results='hide'}
file.copy("posters", "docs/posters", overwrite = TRUE)
```

A series of posters were presented at different conferences where `nlmixr` was compared to `NONMEM`. These findings provide evidence that nlmixr provides a viable open-source parameter estimation alternative for fitting nonlinear mixed effects pharmacometric models within the R environment.

- ACoP 2016, Seattle, USA: <a href="posters/PosterACoP2016.pdf" target="_blank">PosterACoP2016</a>
- WCoP 2016, Brisbane, Australia: <a href="posters/PosterWCoP2016.pdf" target="_blank">PosterWCoP2016</a>
- PAGE 2017, Budapest, Hungary: <a href="posters/PosterPAGE2017.pdf" target="_blank">PosterPAGE2017</a>
- ACoP 2017, Fort Lauderdale, USA: <a href="posters/PosterACoP2017.pdf" target="_blank">PosterACoP2017</a>

On 8 December 2016, Rik Schoemaker presented a seminar on `nlmixr` at Uppsala University with the title: **`nlmixr`: an open-source package for pharmacometric modelling in R** (<a href="posters/PRESnlmixrUppsala161208.pdf" target="_blank">PresentationUppsala161208</a>).

`nlmixr` was presented at the 12^th^ Pharmacometrics Network Benelux Meeting (29 March 2018) with the title: **Simulation (RxODE) and parameter estimation in `nlmixr`** (<a href="posters/PRES nlmixr PNB 180326.pdf" target="_blank">PresentationPNB180326</a>).


## Course: PAGE 2018

The `nlmixr` team presented a one-day course at PAGE 2018, in Montreux, Switzerland. The examples used in the course are presented [here](https://github.com/nlmixrdevelopment/PAGE-2018).

<!-- ### Examplomycin: a simple PK model with covariates -->

<!-- First, we load required libraries... -->

<!-- ```{r eval=F} -->

<!-- library(gridExtra) -->
<!-- library(RxODE) -->
<!-- library(MASS) -->
<!-- library(data.table) -->
<!-- library(ggplot2) -->
<!-- library(nlmixr) -->
<!-- library(xpose) -->
<!-- library(xpose.nlmixr) -->
<!-- library(shinyMixR) -->
<!-- library(vpc) -->

<!-- ``` -->

<!-- We simulate some PK data for our imaginary compound using `RxODE`: -->

<!-- ```{r eval=F} -->

<!-- mod <- RxODE({ -->
<!--   k10 = CL/V2 -->
<!--   k12 = Q/V2 -->
<!--   k21 = Q/V3 -->
<!--   d/dt(depot) =-KA*depot; -->
<!--   d/dt(centr) = KA*depot - k10*centr - k12*centr + k21*peri; -->
<!--   d/dt(peri)  =                        k12*centr - k21*peri; -->
<!--   C2 = centr/V2; -->
<!--   C3 = peri/V3; -->
<!--   cp = C2 #*(1+cp.err) -->
<!-- }) -->

<!-- theta <- c(TKA=1.05, TCL=0.121, TV2=1.939, -->
<!--            TQ=0.282, TV3=5.65) -->

<!-- omegaCor <- matrix(c(1,    0.5, 0.25, 0.1,  0, -->
<!--                      0.5,  1,   0.5,  0.1,  0, -->
<!--                      0.25, 0.5, 1,    0.1,  0, -->
<!--                      0.1,  0.1, 0.1,  1,    0, -->
<!--                      0,    0,   0,    0,    1), dimnames=list(NULL,c("eta.CL","eta.V2","eta.V3", "eta.Q", "eta.KA")), nrow=5) -->

<!-- iiv.sd <- c(0.25, 0.25, 0.25, 0.3, 0.3) ## SDs of model parameters -->

<!-- iiv <- iiv.sd %*% t(iiv.sd) -->
<!-- omega <- iiv * omegaCor  # covariance matrix -->

<!-- sigma <- diag(1)*0.1 -->
<!-- dimnames(sigma) <- list(NULL, c("cp.err")) -->

<!-- set.seed(740727) -->

<!-- mv <- mvrnorm(40, rep(0, dim(omega)[1]), omega) # Sample from covariance matrix -->

<!-- # Combine population parameters with IIV -->
<!-- params.all <- -->
<!--   data.table( -->
<!--     "ID" = seq(1:40), -->
<!--     "CL" = theta['TCL'] * exp(mv[, 1]), -->
<!--     "V2" = theta['TV2'] * exp(mv[, 2]), -->
<!--     "V3" = theta['TV3'] * exp(mv[, 3]), -->
<!--     "Q"  = theta['TQ']  * exp(mv[, 4]), -->
<!--     "KA" = theta['TKA'] * exp(mv[, 5]), -->
<!--     "WT" = round(rnorm(40,70,15)), -->
<!--     "SEX" = rbinom(n = 40, prob = 0.5, size =1) -->
<!--   ) -->
<!-- # set the doses (looping through the 4 doses) -->
<!-- params.all[, AMT := 1200] -->

<!-- params.all$CL <- params.all$CL * (params.all$WT/70)^0.75 -->
<!-- params.all$V2 <- params.all$V2 * (1 - 0.2 * params.all$SEX) -->

<!-- params.all$lWT <- log(params.all$WT/70) -->

<!-- s = lapply(1:40, function(i) { -->
<!--   # selects the parameters associated with the subject to be simulated -->
<!--   params <- params.all[i] -->
<!--   # creates an eventTable with 7 doses every 24 hours -->
<!--   ev <- eventTable() -->
<!--   ev$add.dosing( -->
<!--     dose = params$AMT, -->
<!--     nbr.doses = 28, -->
<!--     dosing.to = 1, -->
<!--     dosing.interval = 24, -->
<!--     rate = NULL, -->
<!--     start.time = 0 -->
<!--   ) -->

<!--   smp <- c(round(runif(1, 0, 1),3), -->
<!--            round(runif(1, 1, 3),3), -->
<!--            round(runif(1, 3, 6), 3), -->
<!--            round(runif(1, 6, 12), 3), -->
<!--            round(runif(1, 18, 23.9), 3), -->
<!--            round(runif(1, 168, 169),3), -->
<!--            round(runif(1, 169, 171),3), -->
<!--            round(runif(1, 171, 180),3), -->
<!--            round(runif(1, 188, 191.9),3)) -->

<!--   ev$add.sampling(smp) -->

<!--   x <- as.data.table(mod$run(params, ev)) -->
<!--   x$rv <- rnorm(nrow(x), 0, 0.075) -->
<!--   x$DV <- round(x$cp * (1 + x$rv),1) -->
<!--   x$ID <- i -->

<!--   x[, names(params) := params] -->
<!-- }) -->

<!-- sim <- as.data.table(do.call("rbind", s)) -->

<!-- setnames(sim, "time", "TIME") -->

<!-- Dose <- expand.grid(TIME = seq(0, 7 * 24, 24), ID = params.all$ID, DV=0) -->
<!-- Dose <- data.table(merge(Dose, params.all, by = "ID")) -->
<!-- Dose[, EVID := 101] -->

<!-- sim[, EVID := 0] -->
<!-- sim[, AMT := 0] -->

<!-- sim <- sim[,c("ID","TIME","DV","WT","SEX","AMT","EVID")] -->
<!-- dat <- rbind(sim, Dose[,c("ID","TIME","DV","WT","SEX","AMT","EVID")]) -->
<!-- setkey(dat, ID, TIME) -->

<!-- ``` -->


<!-- #### Data exploration -->

<!-- Plotting the data reveals that we are probably dealing with a two-compartmental system (Figure \@ref(fig:plotdata)). That said, let's run through all possibilities. -->

<!-- ```{r eval=F} -->

<!-- dat$Day <- "Day 1" -->
<!-- dat$Day[dat$TIME>167] <- "Day 8" -->

<!-- ggplot(subset(data.frame(dat), EVID==0), aes(TIME, DV)) + geom_point(col="#1F4E79") + -->
<!--   geom_line(aes(group=ID), col="#1F4E79") + -->
<!--   scale_x_continuous("Time (h)") + -->
<!--   scale_y_log10("Concentration (mg/L)") + -->
<!--   facet_wrap(~ Day, scales="free_x") -->

<!-- ``` -->

<!-- ```{r plotdata, fig.cap='Simulated examplomycin data, by day', out.width='80%', fig.align='center', echo=FALSE, eval=TRUE} -->
<!-- knitr::include_graphics("figures/examplomycin_plotdata.png") -->
<!-- ``` -->

<!-- #### Model fitting -->

<!-- Working through model development in the usual way, we eventually arrive at a model which looks like this... -->

<!-- ```{r eval=F} -->

<!-- model.2cpt.ode.wtcl.sexv2 <- function() { -->
<!--   ini({ -->
<!--     tka <- log(1.14) -->
<!--     tcl <- log(0.0190) -->
<!--     tv2  <- log(2.12) -->
<!--     tv3  <- log(20.4) -->
<!--     tq   <- log(0.383) -->
<!--     wteff  <- 0.35 -->
<!--     sexeff <- -0.2 -->
<!--     eta.ka ~ 1 -->
<!--     eta.cl ~ 1 -->
<!--     eta.v2 ~ 1 -->
<!--     eta.v3 ~ 1 -->
<!--     eta.q ~ 1 -->
<!--     prop.err <- 0.075 -->
<!--   }) -->
<!--   model({ -->
<!--     ka <- exp(tka + eta.ka) -->
<!--     cl <- exp(tcl + wteff*lWT + eta.cl) -->
<!--     v2 <- exp(tv2 + sexeff*SEX + eta.v2) -->
<!--     v3 <- exp(tv3 + eta.v3) -->
<!--     q  <- exp(tq + eta.q) -->
<!--     d/dt(depot) = -ka * depot -->
<!--     d/dt(center) = ka * depot - cl / v2 * center + q/v3 * periph - q/v2 * center -->
<!--     d/dt(periph) = q/v2 * center - q/v3 * periph -->
<!--     cp = center / v2 -->
<!--     cp ~ prop(prop.err) -->
<!--   }) -->
<!-- } -->

<!-- fit.2cpt.ode.wtcl.sexv2.saem <- nlmixr(model.2cpt.ode.wtcl.sexv2, dat, est="saem") -->

<!-- ``` -->

<!-- Notice how covariates have been included. `lWT` is pre-processed body weight (`log(WT/70)`) and `SEX` is a binary variable equal to 0 (male) or 1 (female). -->

<!-- We can now have a look at some diagnostics... -->

<!-- ```{r eval=F} -->

<!-- print(fit.2cpt.ode.wtcl.sexv2.saem) -->

<!-- ``` -->

<!-- GOF plots (Figure \@ref(fig:2cptwtsex-xpose)) look OK and the VPC suggests the model does a good job of predicting the data (Figure \@ref(fig:2cptwtsex-vpc)). -->


<!-- ```{r eval=F} -->

<!-- # create xpose data object -->
<!-- xp.2cpt.wtcl.sexv2.ode.saem <- xpose_data_nlmixr(fit.2cpt.ode.wtcl.sexv2.saem,  -->
<!--                                                  xp_theme = theme_xp_nlmixr()) -->

<!-- xp1 <- dv_vs_pred(xp.2cpt.wtcl.sexv2.ode.saem, title = "DV vs PRED",  -->
<!--                   subtitle = NULL, caption = NULL) +  -->
<!--   coord_cartesian(ylim=c(0,1000), xlim=c(0,1000)) -->

<!-- xp2 <- dv_vs_ipred(xp.2cpt.wtcl.sexv2.ode.saem, title = "DV vs IPRED",  -->
<!--                    subtitle = NULL, caption = NULL) +  -->
<!--   coord_cartesian(ylim=c(0,1000), xlim=c(0,1000)) -->

<!-- xp3 <- res_vs_idv(xp.2cpt.wtcl.sexv2.ode.saem, res = "CWRES", title = "CWRES vs time",  -->
<!--                   subtitle = NULL, caption = NULL) +  -->
<!--   coord_cartesian(ylim=c(-3.5,3.5)) -->

<!-- xp4 <- res_vs_pred(xp.2cpt.wtcl.sexv2.ode.saem, res = "CWRES", title = "CWRES vs PRED",  -->
<!--                    subtitle = NULL, caption = NULL)+  -->
<!--   coord_cartesian(ylim=c(-3.5,3.5)) -->

<!-- grid.arrange(xp1, xp2, xp3, xp4, nrow=2) -->

<!-- ``` -->

<!-- ```{r 2cptwtsex-xpose, fig.cap='Basic goodness-of-fit plots for base model with weight on CL and sex on V2', out.width='80%', fig.align='center', echo=FALSE, eval=TRUE} -->
<!-- knitr::include_graphics("figures/examplomycin_xpose.png") -->
<!-- ``` -->


<!-- ```{r eval=F} -->

<!-- vpc(fit.2cpt.ode.wtcl.sexv2.saem, nsim=400,show=list(obs_dv=T)) +  -->
<!--   scale_x_continuous("Time (h)") +  -->
<!--   scale_y_continuous("Examplomycin concentration") -->

<!-- ``` -->


<!-- ```{r 2cptwtsex-vpc, fig.cap='VPC for base model with weight on CL and sex on V2, n=400', out.width='80%', fig.align='center', echo=FALSE, eval=TRUE} -->
<!-- knitr::include_graphics("figures/examplomycin_vpc.png") -->
<!-- ``` -->



